<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üî≠ Agent Observability ‚Äî OpenClaw</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f172a;
      --bg2: #1e293b;
      --bg3: #334155;
      --border: #334155;
      --border-dim: rgba(51,65,85,0.5);
      --text: #e2e8f0;
      --text2: #94a3b8;
      --text3: #64748b;
      --blue: #60a5fa;
      --green: #34d399;
      --purple: #a78bfa;
      --orange: #fb923c;
      --pink: #f472b6;
      --yellow: #fbbf24;
      --red: #f87171;
      --font: "SF Mono","Fira Code","JetBrains Mono","Cascadia Code",monospace;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--font); font-size: 13px; }
    a { color: var(--blue); text-decoration: none; }

    .header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); }
    .header h1 { font-size: 1.1rem; font-weight: 700; }
    .header-controls { display: flex; gap: 0.75rem; align-items: center; }
    .header-controls label { font-size: 0.75rem; color: var(--text2); }
    .btn { padding: 0.35rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg2); color: var(--text); cursor: pointer; font-family: var(--font); font-size: 0.75rem; }
    .btn:hover { background: var(--bg3); }
    .btn.active { border-color: var(--blue); color: var(--blue); }

    .container { max-width: 1500px; margin: 0 auto; padding: 1rem 1.5rem; }

    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .stat { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 0.625rem 0.875rem; }
    .stat-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text3); margin-bottom: 0.125rem; }
    .stat-val { font-size: 1.4rem; font-weight: 700; }

    /* Panels */
    .panel { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
    .panel-hdr { padding: 0.5rem 1rem; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem; }
    .panel-hdr .close { margin-left: auto; cursor: pointer; color: var(--text3); font-size: 0.7rem; }
    .panel-body { max-height: 420px; overflow-y: auto; }
    .panel-body.tall { max-height: 650px; }

    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media(max-width:900px) { .grid2 { grid-template-columns: 1fr; } }

    /* Commands */
    .cmd-row { display: grid; grid-template-columns: 64px auto 1fr 60px; gap: 0.5rem; padding: 0.3rem 1rem; border-bottom: 1px solid var(--border-dim); align-items: center; cursor: pointer; font-size: 0.72rem; }
    .cmd-row:hover { background: rgba(51,65,85,0.25); }
    .cmd-time { color: var(--text3); }
    .cmd-tool { font-weight: 600; padding: 1px 5px; border-radius: 3px; font-size: 0.68rem; display: inline-block; }
    .cmd-args { color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cmd-sid { color: var(--text3); font-size: 0.62rem; text-align: right; }
    .cmd-detail { padding: 0.5rem 1rem; background: rgba(15,23,42,0.7); border-bottom: 1px solid var(--border-dim); font-size: 0.68rem; }
    .cmd-detail .label { color: var(--text3); margin-bottom: 0.15rem; }
    .cmd-detail pre { margin: 0.15rem 0 0.5rem; white-space: pre-wrap; word-break: break-all; color: var(--text2); max-height: 180px; overflow-y: auto; }

    /* Sessions */
    .sess-row { padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-dim); cursor: pointer; }
    .sess-row:hover, .sess-row.active { background: rgba(51,65,85,0.25); }
    .sess-top { display: flex; justify-content: space-between; align-items: center; font-size: 0.78rem; }
    .sess-id { font-weight: 600; }
    .sess-meta { font-size: 0.68rem; color: var(--text2); display: flex; gap: 0.75rem; margin-top: 0.15rem; flex-wrap: wrap; }
    .sess-subagents { margin-top: 0.3rem; padding-left: 0.75rem; border-left: 2px solid var(--pink); }
    .subagent { font-size: 0.68rem; color: var(--text2); padding: 0.1rem 0; }
    .subagent-task { color: var(--pink); }

    /* Transcript */
    .tx-entry { padding: 0.3rem 1rem; border-bottom: 1px solid rgba(51,65,85,0.3); font-size: 0.72rem; }
    .tx-role { font-weight: 600; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.1rem; }
    .tx-role.user { color: var(--blue); }
    .tx-role.assistant { color: var(--green); }
    .tx-role.tool_call { color: var(--yellow); }
    .tx-role.tool_result { color: var(--text3); }
    .tx-role.system { color: var(--purple); }
    .tx-role.model_change { color: var(--orange); }
    .tx-content { white-space: pre-wrap; word-break: break-word; color: var(--text2); max-height: 120px; overflow-y: auto; }

    /* Memory */
    .mem-dir { padding: 0.3rem 1rem; border-bottom: 1px solid var(--border-dim); }
    .mem-dir-name { font-weight: 600; font-size: 0.78rem; margin-bottom: 0.15rem; }
    .mem-file { font-size: 0.68rem; padding: 0.1rem 0 0.1rem 0.6rem; color: var(--text2); cursor: pointer; }
    .mem-file:hover { color: var(--blue); }
    .mem-file .meta { color: var(--text3); font-size: 0.6rem; margin-left: 0.4rem; }
    .mem-content { padding: 0.625rem 1rem; font-size: 0.68rem; white-space: pre-wrap; word-break: break-word; color: var(--text2); max-height: 350px; overflow-y: auto; }
    .mem-back { padding: 0.4rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.7rem; }
    .mem-back a { cursor: pointer; }

    .git-changes { padding: 0.4rem 1rem; }
    .git-row { font-size: 0.68rem; padding: 0.1rem 0; display: flex; gap: 0.5rem; }
    .git-hash { color: var(--blue); font-weight: 600; }
    .git-msg { color: var(--text2); flex: 1; }
    .git-time { color: var(--text3); font-size: 0.6rem; }

    .empty { padding: 1.5rem 1rem; text-align: center; color: var(--text3); font-size: 0.78rem; }
    .loading { text-align: center; padding: 0.75rem; color: var(--text3); }
  </style>
</head>
<body>
  <div class="header">
    <h1>üî≠ Agent Observability</h1>
    <div class="header-controls">
      <label><input type="checkbox" id="autoRefresh" checked> Auto-refresh</label>
      <span id="refreshInterval" style="font-size:0.65rem;color:var(--text3)">4s</span>
      <button class="btn" onclick="refresh()">‚Üª Refresh</button>
    </div>
  </div>

  <div class="container">
    <div class="stats" id="stats"></div>
    <div class="panel" id="commandPanel">
      <div class="panel-hdr">‚ö° Command Stream</div>
      <div class="panel-body" id="commands"></div>
    </div>
    <div class="grid2">
      <div class="panel">
        <div class="panel-hdr">üì° Sessions</div>
        <div class="panel-body" id="sessions"></div>
      </div>
      <div class="panel">
        <div class="panel-hdr">üß† Memory</div>
        <div class="panel-body" id="memory"></div>
      </div>
    </div>
    <div id="transcriptPanel" style="display:none">
      <div class="panel">
        <div class="panel-hdr">
          üìú Transcript ‚Äî <span id="txFile"></span>
          <span class="close" onclick="closeTranscript()">‚úï close</span>
        </div>
        <div class="panel-body tall" id="transcript"></div>
      </div>
    </div>
  </div>

  <script>
    const BASE = window.location.origin;
    const API = BASE + "/api";

    let state = {
      sessions: [],
      commands: [],
      memoryDirs: {},
      memoryChanges: [],
      selectedSession: null,
      transcript: [],
      selectedMemFile: null,
      memFileContent: null,
      expandedCmds: new Set(),
    };

    // ---- Fetch helpers ----
    async function fetchJson(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function refresh() {
      try {
        const [sessData, cmdData, memData] = await Promise.all([
          fetchJson(API + "/sessions"),
          fetchJson(API + "/commands"),
          fetchJson(API + "/memory"),
        ]);
        state.sessions = sessData.sessions || [];
        state.commands = cmdData.commands || [];
        state.memoryDirs = memData.directories || {};
        state.memoryChanges = memData.recentChanges || [];

        if (state.selectedSession) {
          const txData = await fetchJson(API + "/session/" + encodeURIComponent(state.selectedSession) + "/transcript");
          state.transcript = txData.entries || [];
        }
      } catch (e) {
        console.error("Refresh error:", e);
      }
      render();
    }

    // ---- Rendering ----
    function render() {
      renderStats();
      renderCommands();
      renderSessions();
      renderMemory();
      renderTranscript();
    }

    function relTime(iso) {
      const d = Date.now() - new Date(iso).getTime();
      if (d < 60000) return "now";
      if (d < 3600000) return Math.floor(d / 60000) + "m";
      if (d < 86400000) return Math.floor(d / 3600000) + "h";
      return Math.floor(d / 86400000) + "d";
    }
    function timeOnly(iso) { try { return new Date(iso).toISOString().slice(11,19); } catch { return iso; } }
    function shortId(id) { return id.length > 12 ? id.slice(0,8) + "‚Ä¶" : id; }
    function fmtTokens(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+"M" : n >= 1e3 ? (n/1e3).toFixed(1)+"K" : String(n); }
    function fmtCost(c) { return c === 0 ? "$0" : c < 0.01 ? "$"+c.toFixed(4) : "$"+c.toFixed(2); }
    function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

    function toolColor(n) {
      if (n==="exec"||n==="process") return "#60a5fa";
      if (n==="read"||n==="write"||n==="edit") return "#34d399";
      if (n==="web_search"||n==="web_fetch") return "#a78bfa";
      if (n==="message") return "#fb923c";
      if (n==="sessions_spawn"||n==="subagents") return "#f472b6";
      if (n==="browser") return "#fbbf24";
      return "#94a3b8";
    }

    function renderStats() {
      const s = state.sessions;
      const totalTokens = s.reduce((a,x) => a + (x.tokenUsage?.total||0), 0);
      const totalCost = s.reduce((a,x) => a + (x.cost||0), 0);
      const memFiles = Object.values(state.memoryDirs).reduce((a,f) => a + f.length, 0);
      document.getElementById("stats").innerHTML = [
        { label: "Sessions", val: s.length },
        { label: "Commands", val: state.commands.length },
        { label: "Tokens", val: fmtTokens(totalTokens) },
        { label: "Cost", val: fmtCost(totalCost) },
        { label: "Memory Files", val: memFiles },
      ].map(x => `<div class="stat"><div class="stat-label">${x.label}</div><div class="stat-val">${x.val}</div></div>`).join("");
    }

    function renderCommands() {
      const el = document.getElementById("commands");
      if (!state.commands.length) { el.innerHTML = '<div class="empty">No commands</div>'; return; }
      el.innerHTML = state.commands.slice(0, 100).map(c => {
        const key = c.timestamp + c.toolName + c.sessionId;
        const exp = state.expandedCmds.has(key);
        const color = toolColor(c.toolName);
        return `<div class="cmd-row" data-key="${esc(key)}">
          <span class="cmd-time">${timeOnly(c.timestamp)}</span>
          <span class="cmd-tool" style="background:${color}22;color:${color}">${esc(c.toolName)}</span>
          <span class="cmd-args">${esc(c.args.slice(0,140))}</span>
          <span class="cmd-sid">${esc(shortId(c.sessionId))}</span>
        </div>` + (exp ? `<div class="cmd-detail">
          <div class="label">Arguments:</div><pre>${esc(c.args)}</pre>
          ${c.resultPreview ? `<div class="label">Result:</div><pre>${esc(c.resultPreview)}</pre>` : ""}
        </div>` : "");
      }).join("");
      el.querySelectorAll(".cmd-row").forEach(row => {
        row.addEventListener("click", () => {
          const k = row.dataset.key;
          if (state.expandedCmds.has(k)) state.expandedCmds.delete(k);
          else state.expandedCmds.add(k);
          renderCommands();
        });
      });
    }

    function renderSessions() {
      const el = document.getElementById("sessions");
      if (!state.sessions.length) { el.innerHTML = '<div class="empty">No sessions</div>'; return; }
      el.innerHTML = state.sessions.map(s => {
        const active = state.selectedSession === s.file ? " active" : "";
        const subs = (s.subAgents||[]).map(sa =>
          `<div class="subagent"><span class="subagent-task">ü§ñ ${esc(sa.task)}</span>${sa.model ? ` <span style="color:var(--text3)">(${esc(sa.model)})</span>` : ""}</div>`
        ).join("");
        return `<div class="sess-row${active}" data-file="${esc(s.file)}">
          <div class="sess-top">
            <span class="sess-id">${esc(shortId(s.id))}</span>
            <span style="font-size:0.68rem;color:var(--text3)">${relTime(s.lastActivity)}</span>
          </div>
          <div class="sess-meta">
            ${s.model ? `<span>ü§ñ ${esc(s.model)}</span>` : ""}
            ${s.channel ? `<span>üì± ${esc(s.channel)}</span>` : ""}
            <span>üí¨ ${s.messageCount} msgs</span>
            <span>ü™ô ${fmtTokens(s.tokenUsage?.total||0)}</span>
            ${s.cost > 0 ? `<span>üí∞ ${fmtCost(s.cost)}</span>` : ""}
          </div>
          ${subs ? `<div class="sess-subagents">${subs}</div>` : ""}
        </div>`;
      }).join("");
      el.querySelectorAll(".sess-row").forEach(row => {
        row.addEventListener("click", async () => {
          const f = row.dataset.file;
          if (state.selectedSession === f) { closeTranscript(); return; }
          state.selectedSession = f;
          state.transcript = [];
          render();
          const txData = await fetchJson(API + "/session/" + encodeURIComponent(f) + "/transcript");
          state.transcript = txData.entries || [];
          render();
        });
      });
    }

    function renderMemory() {
      const el = document.getElementById("memory");
      if (state.selectedMemFile && state.memFileContent !== null) {
        el.innerHTML = `<div class="mem-back"><a onclick="closeMemFile()">‚Üê Back</a> <strong style="margin-left:0.4rem">${esc(state.selectedMemFile)}</strong></div>
          <div class="mem-content">${esc(state.memFileContent)}</div>`;
        return;
      }
      let html = "";
      for (const [dir, files] of Object.entries(state.memoryDirs)) {
        html += `<div class="mem-dir"><div class="mem-dir-name">üìÅ ${esc(dir)}/ (${files.length})</div>`;
        files.slice(0, 10).forEach(f => {
          html += `<div class="mem-file" data-path="${esc(dir + "/" + f.file)}">${esc(f.file)}<span class="meta">${relTime(f.modifiedAt)}</span></div>`;
        });
        if (files.length > 10) html += `<div class="mem-file" style="color:var(--text3)">+${files.length-10} more‚Ä¶</div>`;
        html += "</div>";
      }
      if (state.memoryChanges.length) {
        html += `<div style="padding:0.5rem 1rem;border-top:1px solid var(--border);font-weight:600;font-size:0.78rem">Recent Commits</div><div class="git-changes">`;
        state.memoryChanges.slice(0, 10).forEach(c => {
          html += `<div class="git-row"><span class="git-hash">${esc(c.hash)}</span><span class="git-msg">${esc(c.message)}</span><span class="git-time">${relTime(c.timestamp)}</span></div>`;
        });
        html += "</div>";
      }
      el.innerHTML = html || '<div class="empty">No memory files</div>';
      el.querySelectorAll(".mem-file[data-path]").forEach(f => {
        f.addEventListener("click", async () => {
          state.selectedMemFile = f.dataset.path;
          state.memFileContent = "Loading‚Ä¶";
          renderMemory();
          const data = await fetchJson(API + "/memory/file/" + encodeURIComponent(f.dataset.path));
          state.memFileContent = data.content || "(empty)";
          renderMemory();
        });
      });
    }

    function renderTranscript() {
      const panel = document.getElementById("transcriptPanel");
      if (!state.selectedSession) { panel.style.display = "none"; return; }
      panel.style.display = "block";
      document.getElementById("txFile").textContent = state.selectedSession;
      const el = document.getElementById("transcript");
      if (!state.transcript.length) { el.innerHTML = '<div class="loading">Loading transcript‚Ä¶</div>'; return; }
      el.innerHTML = state.transcript.map(e => {
        const content = e.content || e.toolArgs || e.result || "";
        return `<div class="tx-entry">
          <div class="tx-role ${e.type}">${timeOnly(e.timestamp)} ‚Äî ${e.type}${e.toolName ? " ["+esc(e.toolName)+"]" : ""}</div>
          <div class="tx-content">${esc(content)}</div>
        </div>`;
      }).join("");
    }

    function closeTranscript() {
      state.selectedSession = null;
      state.transcript = [];
      render();
    }
    window.closeMemFile = function() {
      state.selectedMemFile = null;
      state.memFileContent = null;
      renderMemory();
    };

    // ---- Auto-refresh ----
    let intervalId = null;
    function startAutoRefresh() {
      if (intervalId) return;
      intervalId = setInterval(() => { if (document.getElementById("autoRefresh").checked) refresh(); }, 4000);
    }
    refresh().then(startAutoRefresh);
  </script>
</body>
</html>
